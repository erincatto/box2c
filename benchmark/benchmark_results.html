<!DOCTYPE html>
<html lang="en">

<!-- https://cdn.jsdelivr.net/gh/erincatto/box2c@main/benchmark/amd7950x/joint_grid.csv -->

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Box2D Benchmarks</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
</head>

<body>
    <h1>Box2D Benchmarks</h1>

    <label for="csvSelect">Select Benchmark:</label>
    <select id="csvSelect">
        <option value="">--Benchmark--</option>
    </select>

    <button id="loadButton">Load Data</button>

    <canvas id="myChart"></canvas>

    <script>
        // Replace 'your_username' and 'your_repository' with your GitHub username and repository name
        const repoUrl = 'https://raw.githubusercontent.com/erincatto/box2c/main/benchmark';

        const benchmarks = [
            {
                label: 'Joint Grid',
                file: 'joint_grid.csv',
                description: '10k Circles, 19800 Revolute Joints'
            },
            {
                label: 'Large Pyramid',
                file: 'large_pyramid.csv',
                description: '5050 boxes'
            },
            {
                label: 'Many Pyramids',
                file: 'many_pyramids.csv',
                description: '400 x 55 boxes'
            },
            {
                label: 'Smash',
                file: 'smash.csv',
                description: 'Large Box Colliding with 9600 Small Boxes'
            },
            {
                label: 'Tumbler',
                file: 'tumbler.csv',
                description: '2026 Small Boxes Tumbling in a Large Hollow Box'
            }
        ];

        const processors = ['amd7950x'];

        const csvSelect = document.getElementById('csvSelect');
        const loadButton = document.getElementById('loadButton');
        let chart = null;

        // Populate the select element
        for (var i = 0; i < benchmarks.length; ++i) {
            const option = document.createElement('option');
            option.value = i;
            option.textContent = benchmarks[i].label;
            csvSelect.appendChild(option);
        }

        async function fetchCSV(url) {
            const response = await fetch(url);
            return response.text();
        }

        // async function fetchBranches() {
        //     const url = `https://api.github.com/repos/${username}/${repository}/branches`;
        //     const response = await fetch(url);
        //     if (!response.ok) {
        //         throw new Error(`HTTP error! status: ${response.status}`);
        //     }
        //     return response.json();
        // }

        // async function populateBranches() {
        //     try {
        //         const branches = await fetchBranches();
        //         branchSelect.innerHTML = ''; // Clear existing options

        //         branches.forEach(branch => {
        //             const option = document.createElement('option');
        //             option.value = branch.name;
        //             option.textContent = branch.name;
        //             branchSelect.appendChild(option);
        //         });

        //         // Select the first branch by default
        //         if (branches.length > 0) {
        //             currentBranch = branches[0].name;
        //             branchSelect.value = currentBranch;
        //         }
        //     } catch (error) {
        //         console.error('Error fetching branches:', error);
        //         branchSelect.innerHTML = '<option value="">Error loading branches</option>';
        //     }
        // }

        async function loadData(file) {
            const datasets = [];

            for (const processor of processors) {
                const csvUrl = repoUrl + '/' + processor + '/' + file;

                console.log(csvUrl);

                try {
                    const csv = await fetchCSV(csvUrl);
                    const csvResult = Papa.parse(csv, {header: true, skipEmptyLines: true});
                    const data = csvResult.data;

                    console.log(data);

                    datasets.push({
                        label: processor,
                        data: data.map(row => ({ x: row.threads, y: row.fps })),
                        fill: false
                    });
                }
                catch (error) {
                    console.error(`Error loading the CSV file (${csvUrl}):`, error);
                    throw new Error('Failed to load the CSV file. It may be missing or inaccessible.');
                }
            }

            return datasets;
        }

        async function createChart(datasets, index) {
            const ctx = document.getElementById('myChart').getContext('2d');

            const benchmark = benchmarks[index];

            //console.log(benchmark);

            if (chart) {
                chart.destroy(); // Destroy the previous chart if it exists
            }

            chart = new Chart(ctx,
                {
                    type: 'line',
                    data: { datasets },
                    options: {
                        plugins: {
                            title: {
                                display: true,
                                text: benchmark.label + ': ' + benchmark.description,
                            },
                            legend: {
                                display: true
                            },
                        },
                        scales: {
                            x: {
                                type: 'linear',
                                position: 'bottom'
                            }
                        }
                    }
                });
        }

        // connect button listener
        loadButton.addEventListener('click', async () => {
            const index = parseInt(csvSelect.value);
            console.log(index);
            if (isNaN(index)) {
                alert('Please select a benchmark');
            }
            else {
                try {
                    const benchmark = benchmarks[index];
                    const datasets = await loadData(benchmark.file);
                    console.log(datasets);

                    await createChart(datasets, index);
                }
                catch (error) {
                    // failed to load data
                    alert(error.message);
                    if (chart) {
                        chart.destroy();
                        chart = null;
                    }
                }
            }
        });
    </script>
</body>

</html>