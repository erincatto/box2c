<!DOCTYPE html>
<html lang="en">

<!-- https://cdn.jsdelivr.net/gh/erincatto/box2c@main/benchmark/amd7950x/joint_grid.csv -->

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Box2D Benchmarks</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
</head>

<body>
    <h1>Box2D Benchmarks</h1>

    <label for="branchSelect">Select Branch:</label>
    <select id="branchSelect">
        <option value="">Loading branches...</option>
    </select>

    <button id="loadButton">Load Data</button>
    
    <canvas id="joint_grid"></canvas>
    <canvas id="large_pyramid"></canvas>
    <canvas id="many_pyramids"></canvas>
    <canvas id="smash"></canvas>
    <canvas id="tumbler"></canvas>

    <script>
        // Replace 'your_username' and 'your_repository' with your GitHub username and repository name
        const repoUrl = 'https://raw.githubusercontent.com/erincatto/box2c/main/benchmark';
        const repoBaseUrl = 'https://raw.githubusercontent.com/erincatto/box2c';

        const benchmarks = [
            {
                label: 'Joint Grid',
                id: 'joint_grid',
                description: '10k Circles, 19800 Revolute Joints',
                chartData: null,
                chart: null
            },
            {
                label: 'Large Pyramid',
                id: 'large_pyramid',
                description: '5050 boxes',
                csvData: null,
                chart: null
            },
            {
                label: 'Many Pyramids',
                id: 'many_pyramids',
                description: '400 x 55 boxes',
                csvData: null,
                chart: null
            },
            {
                label: 'Smash',
                id: 'smash',
                description: 'Large Box Colliding with 9600 Small Boxes',
                csvData: null,
                chart: null
            },
            {
                label: 'Tumbler',
                id: 'tumbler',
                description: '2026 Small Boxes Tumbling in a Large Hollow Box',
                csvData: null,
                chart: null
            }
        ];

        const processors = ['amd7950x', 'm2air'];
        const branchSelect = document.getElementById('branchSelect');
        const loadButton = document.getElementById('loadButton');
        var currentBranch = null;

        async function fetchCSV(url) {
            const response = await fetch(url);
            return response.text();
        }

        async function fetchBranches() {
            const url = `https://api.github.com/repos/erincatto/box2c/branches`;
            const response = await fetch(url);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        }

        async function populateBranches() {
            try {
                const branches = await fetchBranches();
                branchSelect.innerHTML = ''; // Clear existing options

                branches.forEach(branch => {
                    if (branch.name != 'main')
                    {
                        const option = document.createElement('option');
                        option.value = branch.name;
                        option.textContent = branch.name;
                        branchSelect.appendChild(option);

                        if (currentBranch == null)
                        {
                            currentBranch = branch.name;
                        }
                    }
                });

                // Select the first branch by default
                // if (branches.length > 0) {
                //     currentBranch = branches[0].name;
                //     branchSelect.value = currentBranch;
                // }
            } catch (error) {
                console.error('Error fetching branches:', error);
                branchSelect.innerHTML = '<option value="">Error loading branches</option>';
            }
        }

        async function loadData(branches, benchmark)
        {
            const datasets = [];

            var file = benchmark.id + '.csv';

            for (const branch of branches)
            {
                for (const processor of processors)
                {
                    const csvUrl = repoBaseUrl + '/' + branch + '/benchmark/' + processor + '/' + file;

                    //console.log(csvUrl);

                    try 
                    {
                        const csv = await fetchCSV(csvUrl);
                        const csvResult = Papa.parse(csv, {header: true, skipEmptyLines: true});
                        const data = csvResult.data;

                        //console.log('data here:');
                        //console.log(data);

                        if (data != null)
                        {
                            datasets.push({
                                label: processor + '-' + branch,
                                // convert the csv data into chart ready data
                                data: data.map(row => ({ x: row.threads, y: row.fps })),
                                fill: false
                            });                        
                        }
                    }
                    catch (error) {
                        console.error(`Error loading the CSV file (${csvUrl}):`, error);
                        throw new Error('Failed to load the CSV file. It may be missing or inaccessible.');
                    }          
                }
            }

            return datasets;
        }

        async function createChart(datasets, benchmark)
        {
            // get the document element for this benchmark
            const ctx = document.getElementById(benchmark.id).getContext('2d');

            //console.log(benchmark);

            if (benchmark.chart)
            {
                benchmark.chart.destroy(); // Destroy the previous chart if it exists
            }

            if (datasets == null)
            {
                return;
            }

            //console.log(datasets);

            benchmark.chart = new Chart(ctx,
                {
                    type: 'line',
                    data: { datasets },
                    options: {
                        plugins: {
                            title: {
                                display: true,
                                text: benchmark.label + ': ' + benchmark.description,
                            },
                            legend: {
                                display: true
                            },
                        },
                        scales: {
                            x: {
                                type: 'linear',
                                position: 'bottom'
                            }
                        }
                    }
                });
        }

        async function createCharts()
        {
            const branches = ['main'];

            if (currentBranch != null)
            {
                branches.push(currentBranch);
            }

            for (const benchmark of benchmarks)
            {
                const datasets = await loadData(branches, benchmark);
                createChart(datasets, benchmark);
            }
        }

        // connect button listener
        loadButton.addEventListener('click', async () => {
            console.log(branchSelect.value);
            if (branchSelect.value == null) {
                alert('No branch selected');
            }
            else {
                try {
                    currentBranch = branchSelect.value;
                    await createCharts();
                }
                catch (error) {
                    // failed to load data
                    alert(error.message);
                }
            }
        });

        createCharts().then(populateBranches());

    </script>
</body>

</html>